!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("tools"),require("lodash")):"function"==typeof define&&define.amd?define("waveform-drawer",["tools","lodash"],t):"object"==typeof exports?exports["waveform-drawer"]=t(require("tools"),require("lodash")):e["waveform-drawer"]=t(e.tools,e.lodash)}("undefined"!=typeof self?self:this,function(e,t){return function(e){function t(a){if(r[a])return r[a].exports;var i=r[a]={i:a,l:!1,exports:{}};return e[a].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,a){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:a})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=1)}([function(t,r){t.exports=e},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=r(2),i=function(e){return e&&e.__esModule?e:{default:e}}(a);t.default=i.default,e.exports=t.default},function(e,t,r){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),l=r(3),h=a(l),u=r(0),c=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(u),p=r(4),f=a(p),d=(function(){function e(t,r){s(this,e)}o(e,[{key:"create",value:function(e){}}]),o(e,[{key:"init",value:function(){}},{key:"destroy",value:function(){}}])}(),function(e){function t(e){var r;s(this,t);var a=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(a.defaultParams={autoCenter:!0,barHeight:1,container:null,cursorColor:"#333",cursorWidth:1,dragSelection:!0,fillParent:!0,height:128,hideScrollbar:!1,interact:!0,maxCanvasWidth:4e3,minPxPerSec:20,partialRender:!1,pixelRatio:c.root.devicePixelRatio,plugins:[],progressColor:"#555",renderer:f.default,responsive:!1,scrollParent:!1,splitChannels:!1,waveColor:"#999"},a.params=c.extend({},a.defaultParams,e),a.container="string"==typeof e.container?document.querySelector(a.params.container):a.params.container,!a.container)throw new Error("Container element not found");if(a.params.maxCanvasWidth<=1)throw new Error("maxCanvasWidth must be greater than 1");if(a.params.maxCanvasWidth%2==1)throw new Error("maxCanvasWidth must be an even number");if(a.tmpEvents=[],a.currentAjax=null,a.drawer=null,"function"!=typeof a.params.renderer)throw new Error("Renderer parameter is invalid");a.Drawer=a.params.renderer,a.initialisedPluginList={},a.isDestroyed=!1,a.isReady=!1,a.progress=0,a.peaks=null;var n=0;return a._onResize=h.default.debounce(function(){n!==a.drawer.wrapper.clientWidth&&(n=a.drawer.wrapper.clientWidth,a.drawBuffer())},"number"==typeof a.params.responsive?a.params.responsive:100),r=a,i(a,r)}return n(t,e),o(t,null,[{key:"create",value:function(e){return new t(e).init()}}]),o(t,[{key:"init",value:function(){return this.registerPlugins(this.params.plugins),this.createDrawer(),this}},{key:"registerPlugins",value:function(e){var t=this;return e.forEach(function(e){return t.addPlugin(e)}),e.forEach(function(e){e.deferInit||t.initPlugin(e.name)}),this.fireEvent("plugins-registered",e),this}},{key:"addPlugin",value:function(e){var t=this;if(!e.name)throw new Error("Plugin does not have a name!");if(!e.instance)throw new Error("Plugin "+e.name+" does not have an instance property!");e.staticProps&&Object.keys(e.staticProps).forEach(function(r){t[r]=e.staticProps[r]});var r=e.instance;return Object.getOwnPropertyNames(c.Observer.prototype).forEach(function(e){r.prototype[e]=c.Observer.prototype[e]}),this[e.name]=new r(e.params||{},this),this.fireEvent("plugin-added",e.name),this}},{key:"initPlugin",value:function(e){if(!this[e])throw new Error("Plugin "+e+" has not been added yet!");return this.initialisedPluginList[e]&&this.destroyPlugin(e),this[e].init(),this.initialisedPluginList[e]=!0,this.fireEvent("plugin-initialised",e),this}},{key:"destroyPlugin",value:function(e){if(!this[e])throw new Error("Plugin "+e+" has not been added yet and cannot be destroyed!");if(!this.initialisedPluginList[e])throw new Error("Plugin "+e+" is not active and cannot be destroyed!");if("function"!=typeof this[e].destroy)throw new Error("Plugin "+e+" does not have a destroy function!");return this[e].destroy(),delete this.initialisedPluginList[e],this.fireEvent("plugin-destroyed",e),this}},{key:"destroyAllPlugins",value:function(){var e=this;Object.keys(this.initialisedPluginList).forEach(function(t){return e.destroyPlugin(t)})}},{key:"createDrawer",value:function(){var e=this;this.drawer=new this.Drawer(this.container,this.params),this.drawer.init(),this.fireEvent("drawer-created",this.drawer),this.params.responsive&&window.addEventListener("resize",this._onResize,!0),this.drawer.on("redraw",function(){e.drawBuffer(),e.drawer.progress(e.progress)}),this.drawer.on("click",function(t,r){e.seekTo(r),e.fireEvent("click",r)}),this.drawer.on("scroll",function(t){e.params.partialRender&&e.drawBuffer(),e.fireEvent("scroll",t)})}},{key:"seekAndCenter",value:function(e){this.seekTo(e),this.drawer.recenter(e)}},{key:"seekTo",value:function(e){var t=this;this.fireEvent("interaction",function(){return t.seekTo(e)});var r=this.params.scrollParent;this.params.scrollParent=!1,this.drawer.progress(e),this.params.scrollParent=r,this.fireEvent("seek",e)}},{key:"stop",value:function(){this.seekTo(0),this.drawer.progress(0)}},{key:"toggleScroll",value:function(){this.params.scrollParent=!this.params.scrollParent,this.drawBuffer()}},{key:"toggleInteraction",value:function(){this.params.interact=!this.params.interact}},{key:"drawBuffer",value:function(){var e=this.drawer.getWidth(),t=e,r=t,a=this.drawer.getScrollX(),i=Math.min(a+e,r);this.params.fillParent&&(!this.params.scrollParent||t<e)&&(r=e,a=0,i=r),a=0,i=r,this.drawer.drawPeaks(this.peaks,r,a,i),this.fireEvent("redraw",this.peaks,r)}},{key:"zoom",value:function(e){this.params.minPxPerSec=e,this.params.scrollParent=!0,this.drawBuffer(),this.drawer.progress(this.progress),this.drawer.recenter(this.getCurrentTime()/this.getDuration()),this.fireEvent("zoom",e)}},{key:"getWidth",value:function(){this.drawer.getWidth()}},{key:"load",value:function(e){return this.empty(),this.loadPeaks(e)}},{key:"loadPeaks",value:function(e){"string"==typeof e?this.getPeaksArray(e,this.havePeaks.bind(this)):e instanceof Array&&this.havePeaks(e)}},{key:"havePeaks",value:function(e){this.peaks=e,this.drawBuffer(),this.fireEvent("ready")}},{key:"getPeaksArray",value:function(e,t){var r=this,a=c.ajax({url:e,responseType:"json"});return this.currentAjax=a,this.tmpEvents.push(a.on("success",function(e,a){t(e),r.currentAjax=null}),a.on("error",function(e){r.fireEvent("error","XHR error: "+e.target.statusText),r.currentAjax=null})),a}},{key:"exportImage",value:function(e,t){return e||(e="image/png"),t||(t=1),this.drawer.getImage(e,t)}},{key:"cancelAjax",value:function(){this.currentAjax&&(this.currentAjax.xhr.abort(),this.currentAjax=null)}},{key:"clearTmpEvents",value:function(){this.tmpEvents.forEach(function(e){return e.un()})}},{key:"empty",value:function(){this.cancelAjax(),this.clearTmpEvents(),this.drawer.progress(0),this.drawer.setWidth(0),this.drawer.drawPeaks({length:this.drawer.getWidth()},0)}},{key:"destroy",value:function(){this.destroyAllPlugins(),this.fireEvent("destroy"),this.cancelAjax(),this.clearTmpEvents(),this.unAll(),this.params.responsive&&window.removeEventListener("resize",this._onResize,!0),this.drawer.destroy(),this.isDestroyed=!0,this.peaks=null}}]),t}(c.Observer));t.default=d,e.exports=t.default},function(e,r){e.exports=t},function(e,t,r){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),o=r(0),l=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(o),h=r(5),u=function(e){return e&&e.__esModule?e:{default:e}}(h),c=function(e){function t(e,r){a(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return n.maxCanvasWidth=r.maxCanvasWidth,n.maxCanvasElementWidth=Math.round(r.maxCanvasWidth/r.pixelRatio),n.hasProgressCanvas=r.waveColor!==r.progressColor,n.halfPixel=.5/r.pixelRatio,n.canvases=[],n.progressWave=null,n}return n(t,e),s(t,[{key:"init",value:function(){this.createWrapper(),this.createElements()}},{key:"createElements",value:function(){this.progressWave=this.wrapper.appendChild(this.style(document.createElement("wave"),{position:"absolute",zIndex:2,left:0,top:0,bottom:0,overflow:"hidden",width:"0",display:"none",boxSizing:"border-box",borderRightStyle:"solid",borderRightWidth:this.params.cursorWidth+"px",borderRightColor:this.params.cursorColor,pointerEvents:"none"})),this.addCanvas()}},{key:"updateSize",value:function(){for(var e=this,t=Math.round(this.width/this.params.pixelRatio),r=Math.ceil(t/this.maxCanvasElementWidth);this.canvases.length<r;)this.addCanvas();for(;this.canvases.length>r;)this.removeCanvas();this.canvases.forEach(function(t,r){var a=e.maxCanvasWidth+2*Math.ceil(e.params.pixelRatio/2);r===e.canvases.length-1&&(a=e.width-e.maxCanvasWidth*(e.canvases.length-1)),e.updateDimensions(t,a,e.height),e.clearWaveForEntry(t)})}},{key:"addCanvas",value:function(){var e={},t=this.maxCanvasElementWidth*this.canvases.length;e.wave=this.wrapper.appendChild(this.style(document.createElement("canvas"),{position:"absolute",left:t+"px",top:0,bottom:0,height:"100%",pointerEvents:"none"})),e.waveCtx=e.wave.getContext("2d"),this.hasProgressCanvas&&(e.progress=this.progressWave.appendChild(this.style(document.createElement("canvas"),{position:"absolute",zIndex:2,left:t+"px",top:0,bottom:0,height:"100%"})),e.progressCtx=e.progress.getContext("2d")),this.canvases.push(e)}},{key:"removeCanvas",value:function(){var e=this.canvases.pop();e.wave.parentElement.removeChild(e.wave),this.hasProgressCanvas&&e.progress.parentElement.removeChild(e.progress)}},{key:"updateDimensions",value:function(e,t,r){var a=Math.round(t/this.params.pixelRatio),i=Math.round(this.width/this.params.pixelRatio);e.start=e.waveCtx.canvas.offsetLeft/i||0,e.end=e.start+a/i,e.waveCtx.canvas.width=t,e.waveCtx.canvas.height=r,this.style(e.waveCtx.canvas,{width:a+"px"}),this.style(this.progressWave,{display:"block"}),this.hasProgressCanvas&&(e.progressCtx.canvas.width=t,e.progressCtx.canvas.height=r,this.style(e.progressCtx.canvas,{width:a+"px"}))}},{key:"clearWave",value:function(){var e=this;this.canvases.forEach(function(t){return e.clearWaveForEntry(t)})}},{key:"clearWaveForEntry",value:function(e){e.waveCtx.clearRect(0,0,e.waveCtx.canvas.width,e.waveCtx.canvas.height),this.hasProgressCanvas&&e.progressCtx.clearRect(0,0,e.progressCtx.canvas.width,e.progressCtx.canvas.height)}},{key:"drawBars",value:function(e,t,r,a){var i=this;l.frame(function(e,t,r,a){if(e){if(e[0]instanceof Array){var n=e;if(i.params.splitChannels)return i.setHeight(n.length*i.params.height*i.params.pixelRatio),void n.forEach(function(e,t){return i.drawBars(e,t,r,a)});e=n[0]}var s=[].some.call(e,function(e){return e<0}),o=s?2:1,h=i.width,u=i.params.height*i.params.pixelRatio,c=u*t||0,p=u/2,f=e.length/o,d=i.params.barWidth*i.params.pixelRatio,v=Math.max(i.params.pixelRatio,~~(d/2)),w=d+v,y=1/i.params.barHeight;if(i.params.normalize){var m=l.max(e),g=l.min(e);y=-g>m?-g:m}for(var x=f/h,P=r;P<a;P+=w){var b=e[Math.floor(P*x*o)]||0,k=Math.round(b/y*p);i.fillRect(P+i.halfPixel,p-k+c,d+i.halfPixel,2*k)}}})(e,t,r,a)}},{key:"drawWave",value:function(e,t,r,a){var i=this;l.frame(function(e,t,r,a){if(e[0]instanceof Array){var n=e;if(i.params.splitChannels)return i.setHeight(n.length*i.params.height*i.params.pixelRatio),void n.forEach(function(e,t){return i.drawWave(e,t,r,a)});e=n[0]}if(![].some.call(e,function(e){return e<0})){var s=[],o=e.length,h=void 0;for(h=0;h<o;h++)s[2*h]=e[h],s[2*h+1]=-e[h];e=s}var u=i.params.height*i.params.pixelRatio,c=u*t||0,p=u/2,f=1/i.params.barHeight;if(i.params.normalize){var d=l.max(e),v=l.min(e);f=-v>d?-v:d}i.drawLine(e,f,p,c,r,a),i.fillRect(0,p+c-i.halfPixel,i.width,i.halfPixel)})(e,t,r,a)}},{key:"drawLine",value:function(e,t,r,a,i,n){var s=this;this.canvases.forEach(function(o){s.setFillStyles(o),s.drawLineToContext(o,o.waveCtx,e,t,r,a,i,n),s.drawLineToContext(o,o.progressCtx,e,t,r,a,i,n)})}},{key:"drawLineToContext",value:function(e,t,r,a,i,n,s,o){if(t){var l=r.length/2,h=this.params.fillParent&&this.width!==l?this.width/l:1,u=Math.round(l*e.start),c=Math.round(l*e.end)+1;if(!(u>o||c<s)){var p=Math.max(u,s),f=Math.min(c,o),d=void 0,v=void 0;for(t.beginPath(),t.moveTo((p-u)*h+this.halfPixel,i+n),d=p;d<f;d++){var w=r[2*d]||0,y=Math.round(w/a*i);t.lineTo((d-u)*h+this.halfPixel,i-y+n)}for(v=f-1;v>=p;v--){var m=r[2*v+1]||0,g=Math.round(m/a*i);t.lineTo((v-u)*h+this.halfPixel,i-g+n)}t.closePath(),t.fill()}}}},{key:"fillRect",value:function(e,t,r,a){var i=Math.floor(e/this.maxCanvasWidth),n=Math.min(Math.ceil((e+r)/this.maxCanvasWidth)+1,this.canvases.length),s=void 0;for(s=i;s<n;s++){var o=this.canvases[s],l=s*this.maxCanvasWidth,h={x1:Math.max(e,s*this.maxCanvasWidth),y1:t,x2:Math.min(e+r,s*this.maxCanvasWidth+o.waveCtx.canvas.width),y2:t+a};h.x1<h.x2&&(this.setFillStyles(o),this.fillRectToContext(o.waveCtx,h.x1-l,h.y1,h.x2-h.x1,h.y2-h.y1),this.fillRectToContext(o.progressCtx,h.x1-l,h.y1,h.x2-h.x1,h.y2-h.y1))}}},{key:"fillRectToContext",value:function(e,t,r,a,i){e&&e.fillRect(t,r,a,i)}},{key:"setFillStyles",value:function(e){e.waveCtx.fillStyle=this.params.waveColor,this.hasProgressCanvas&&(e.progressCtx.fillStyle=this.params.progressColor)}},{key:"getImage",value:function(e,t){var r=this.canvases.map(function(r){return r.wave.toDataURL(e,t)});return r.length>1?r:r[0]}},{key:"updateProgress",value:function(e){this.style(this.progressWave,{width:e+"px"})}}]),t}(u.default);t.default=c,e.exports=t.default},function(e,t,r){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),o=r(0),l=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(o),h=function(e){function t(e,r){a(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.container=e,n.params=r,n.width=0,n.height=r.height*n.params.pixelRatio,n.lastPos=0,n.wrapper=null,n}return n(t,e),s(t,[{key:"style",value:function(e,t){return l.style(e,t)}},{key:"createWrapper",value:function(){this.wrapper=this.container.appendChild(document.createElement("wave")),this.style(this.wrapper,{display:"block",position:"relative",userSelect:"none",webkitUserSelect:"none",height:this.params.height+"px"}),(this.params.fillParent||this.params.scrollParent)&&this.style(this.wrapper,{width:"100%",overflowX:this.params.hideScrollbar?"hidden":"auto",overflowY:"hidden"}),this.setupWrapperEvents()}},{key:"handleEvent",value:function(e,t){!t&&e.preventDefault();var r=e.targetTouches?e.targetTouches[0].clientX:e.clientX,a=this.wrapper.getBoundingClientRect(),i=this.width,n=this.getWidth(),s=void 0;return!this.params.fillParent&&i<n?(s=(r-a.left)*this.params.pixelRatio/i||0)>1&&(s=1):s=(r-a.left+this.wrapper.scrollLeft)/this.wrapper.scrollWidth||0,s}},{key:"setupWrapperEvents",value:function(){var e=this;this.wrapper.addEventListener("click",function(t){var r=e.wrapper.offsetHeight-e.wrapper.clientHeight;if(0!==r){var a=e.wrapper.getBoundingClientRect();if(t.clientY>=a.bottom-r)return}e.params.interact&&e.fireEvent("click",t,e.handleEvent(t))}),this.wrapper.addEventListener("scroll",function(t){return e.fireEvent("scroll",t)})}},{key:"drawPeaks",value:function(e,t,r,a){l.Val.get()&&(this.setWidth(t)||this.clearWave(),this.params.barWidth?this.drawBars(e,0,r,a):this.drawWave(e,0,r,a))}},{key:"resetScroll",value:function(){null!==this.wrapper&&(this.wrapper.scrollLeft=0)}},{key:"recenter",value:function(e){var t=this.wrapper.scrollWidth*e;this.recenterOnPosition(t,!0)}},{key:"recenterOnPosition",value:function(e,t){var r=this.wrapper.scrollLeft,a=~~(this.wrapper.clientWidth/2),i=this.wrapper.scrollWidth-this.wrapper.clientWidth,n=e-a,s=n-r;if(0!==i){if(!t&&-a<=s&&s<a){s=Math.max(-5,Math.min(5,s)),n=r+s}n=Math.max(0,Math.min(i,n)),n!==r&&(this.wrapper.scrollLeft=n)}}},{key:"getScrollX",value:function(){return Math.round(this.wrapper.scrollLeft*this.params.pixelRatio)}},{key:"getWidth",value:function(){return Math.round(this.container.clientWidth*this.params.pixelRatio)}},{key:"setWidth",value:function(e){return this.width!==e&&(this.width=e,this.params.fillParent||this.params.scrollParent?this.style(this.wrapper,{width:""}):this.style(this.wrapper,{width:~~(this.width/this.params.pixelRatio)+"px"}),this.updateSize(),!0)}},{key:"setHeight",value:function(e){return e!==this.height&&(this.height=e,this.style(this.wrapper,{height:~~(this.height/this.params.pixelRatio)+"px"}),this.updateSize(),!0)}},{key:"progress",value:function(e){var t=1/this.params.pixelRatio,r=Math.round(e*this.width)*t;if(r<this.lastPos||r-this.lastPos>=t){if(this.lastPos=r,this.params.scrollParent&&this.params.autoCenter){var a=~~(this.wrapper.scrollWidth*e);this.recenterOnPosition(a)}this.updateProgress(r)}}},{key:"destroy",value:function(){this.unAll(),this.wrapper&&(this.wrapper.parentNode===this.container&&this.container.removeChild(this.wrapper),this.wrapper=null)}},{key:"updateSize",value:function(){}},{key:"drawBars",value:function(e,t,r,a){}},{key:"drawWave",value:function(e,t,r,a){}},{key:"clearWave",value:function(){}},{key:"updateProgress",value:function(e){}}]),t}(l.Observer);t.default=h,e.exports=t.default}])});